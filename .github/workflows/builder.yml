name: BARA ESP32 Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  ARDUINO_CLI_VERSION: "0.35.0"
  ESP32_CORE_VERSION: "2.0.14"

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Arduino CLI
      run: |
        curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
        echo "$(pwd)/bin" >> $GITHUB_PATH
        
    - name: Install ESP32 Core
      run: |
        arduino-cli config init
        arduino-cli core update-index
        arduino-cli core install esp32:esp32@${{ env.ESP32_CORE_VERSION }}
        
    - name: Install Dependencies
      run: |
        arduino-cli lib install "ArduinoJson"
        arduino-cli lib install "DFRobotDFPlayerMini"
        
    - name: Compile for ESP32 Dev Module
      run: |
        arduino-cli compile --fqbn esp32:esp32:esp32 mm.ino --output-dir build/esp32_dev
        
    - name: Compile for ESP32 WROOM
      run: |
        arduino-cli compile --fqbn esp32:esp32:esp32wroom mm.ino --output-dir build/esp32_wroom
        
    - name: Compile for ESP32 WROVER
      run: |
        arduino-cli compile --fqbn esp32:esp32:esp32wrover mm.ino --output-dir build/esp32_wrover
        
    - name: Create Release Artifacts
      run: |
        mkdir -p release
        cp build/esp32_dev/mm.ino.bin release/bara_esp32_dev.bin
        cp build/esp32_dev/mm.ino.partitions.bin release/partitions_esp32_dev.bin
        cp build/esp32_wroom/mm.ino.bin release/bara_esp32_wroom.bin
        cp build/esp32_wroom/mm.ino.partitions.bin release/partitions_esp32_wroom.bin
        cp build/esp32_wrover/mm.ino.bin release/bara_esp32_wrover.bin
        cp build/esp32_wrover/mm.ino.partitions.bin release/partitions_esp32_wrover.bin
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: bara-firmware
        path: release/
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: release/*

name: Build ESP32 Bluetooth Jammer

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *'  # بناء يومي

env:
  ARDUINO_CLI_VERSION: "0.35.0"
  ESP32_CORE_VERSION: "3.0.7"

jobs:
  build:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        board: [
          'esp32:esp32:esp32',
          'esp32:esp32:esp32s2',
          'esp32:esp32:esp32s3', 
          'esp32:esp32:esp32c3'
        ]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Arduino CLI
      run: |
        wget -O arduino-cli.tar.gz https://downloads.arduino.cc/arduino-cli/arduino-cli_latest_Linux_64bit.tar.gz
        tar xf arduino-cli.tar.gz
        sudo mv arduino-cli /usr/local/bin/
        arduino-cli version
        
    - name: Configure Arduino CLI
      run: |
        arduino-cli config init
        arduino-cli config set library.enable_unsafe_install true
        arduino-cli core update-index --additional-urls https://espressif.github.io/arduino-esp32/package_esp32_index.json
        
    - name: Install ESP32 Core
      run: |
        arduino-cli core install esp32:esp32@${{ env.ESP32_CORE_VERSION }} --additional-urls https://espressif.github.io/arduino-esp32/package_esp32_index.json
        
    - name: Verify Board Support
      run: |
        arduino-cli core list
        arduino-cli board listall
        
    - name: Compile for ${{ matrix.board }}
      run: |
        echo "Building for ${{ matrix.board }}"
        arduino-cli compile --fqbn ${{ matrix.board }} mm.ino --output-dir build/${{ matrix.board }} --warnings all
        
    - name: Collect Binaries
      run: |
        mkdir -p firmware_binaries
        find build -name "*.bin" -exec cp {} firmware_binaries \;
        find build -name "*.elf" -exec cp {} firmware_binaries \;
        ls -la firmware_binaries/
        
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: firmware-${{ matrix.board }}
        path: firmware_binaries/
        retention-days: 90

  release:
    needs: build
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/')
    
    steps:
    - name: Download all artifacts
      uses: actions/download-artifact@v4
      
    - name: Create Release
      uses: softprops/action-gh-release@v1
      with:
        files: |
          firmware-*/mm.ino.bin
          firmware-*/mm.ino.elf
        body: |
          # ESP32 Bluetooth Jammer Firmware
          
          ## ⚠️ تحذير هام
          هذا البرنامج للأغراض التعليمية والبحثية فقط.
          استخدامه قد يكون غير قانوني في بعض البلدان.
          
          ## المميزات
          - تشويش قوي على Bluetooth
          - اكتشاف تلقائي للأجهزة
          - تشويش مركز على أجهزة محددة
          - دعم جميع أنواع ESP32
          
          ## الأجهزة المدعومة
          - ESP32
          - ESP32-S2
          - ESP32-S3
          - ESP32-C3

name: BARA ESP32 Build

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

env:
  ARDUINO_CLI_VERSION: "0.35.0"
  ESP32_CORE_VERSION: "2.0.14"

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Arduino CLI
      run: |
        curl -fsSL https://raw.githubusercontent.com/arduino/arduino-cli/master/install.sh | sh
        echo "$(pwd)/bin" >> $GITHUB_PATH
        
    - name: Setup ESP32 Core
      run: |
        arduino-cli config init
        arduino-cli core update-index
        arduino-cli core install esp32:esp32@${{ env.ESP32_CORE_VERSION }}
        
    - name: Install Dependencies
      run: |
        arduino-cli lib install "ArduinoJson"
        arduino-cli lib install "WebServer"
        
    - name: Compile BARA Tool
      run: |
        arduino-cli compile --fqbn esp32:esp32:esp32 mm.ino --output-dir ./build
      
    - name: Upload Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: bara-firmware
        path: |
          build/mm.ino.bin
          build/mm.ino.partitions.bin
        retention-days: 30
        
    - name: Create Release
      if: startsWith(github.ref, 'refs/tags/')
      uses: softprops/action-gh-release@v1
      with:
        files: |
          build/mm.ino.bin
          build/mm.ino.partitions.bin
